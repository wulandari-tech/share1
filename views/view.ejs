<%- include('./partials/header') %>

<div class="max-w-5xl mx-auto space-y-8">
  <article class="bg-gray-800 shadow-xl rounded-xl p-6 md:p-10">
    <header class="mb-6 border-b border-gray-700 pb-6">
      <div class="flex flex-col sm:flex-row justify-between items-start">
        <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-primary-400 to-pink-500 leading-tight mb-3 sm:mb-0 flex-grow">
          <%= code.title %>
        </h1>
        <div class="flex space-x-3 flex-shrink-0 self-start sm:self-center mt-2 sm:mt-0">
            <% if (currentUser && code.uploader && currentUser._id.toString() === code.uploader._id.toString()) { %>
                <a href="/codes/<%= code._id %>/edit" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-md transition duration-150 flex items-center">
                    <i class="fas fa-edit mr-2"></i> Edit
                </a>
                <form action="/codes/<%= code._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this post?');">
                    <button type="submit" class="text-sm bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-md transition duration-150 flex items-center">
                        <i class="fas fa-trash mr-2"></i> Delete
                    </button>
                </form>
            <% } else if (currentUser) { %>
                <button onclick="openReportPostModal()" class="text-sm bg-red-700 hover:bg-red-800 text-white font-semibold px-3 py-2 rounded-md transition duration-150 flex items-center">
                    <i class="fas fa-flag mr-1.5"></i> Report Post
                </button>
            <% } %>
        </div>
      </div>
      <div class="mt-4 text-sm text-gray-400 flex flex-wrap gap-x-4 gap-y-2 items-center">
        <span><i class="fas fa-user mr-1.5 text-primary-400"></i> By <a href="/<%= code.uploader.username.toLowerCase() %>" class="hover:underline"><%= code.uploader ? code.uploader.username : 'Unknown' %></a></span>
        <span><i class="fas fa-calendar-alt mr-1.5 text-primary-400"></i> <%= new Date(code.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></span>
        <span><i class="fas fa-tag mr-1.5 text-primary-400"></i> <span class="bg-gray-700 px-2 py-0.5 rounded-full text-xs"><%= code.snippetLanguage %></span></span>
        <span><i class="fas fa-eye mr-1.5 text-primary-400"></i> <%= code.views || 0 %> views</span>
        <% if (!code.isPublic) { %>
          <span class="text-yellow-400"><i class="fas fa-lock mr-1.5"></i> Private Post</span>
        <% } %>
      </div>
    </header>

    <% if (code.description) { %>
      <div class="prose prose-invert prose-sm md:prose-base max-w-none mb-8 text-gray-300">
        <h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-3">Description</h2>
        <p><%- code.description.replace(/\n/g, '<br>') %></p>
      </div>
    <% } %>

    <% if (code.isSnippetTextFile && typeof code.fetchedSnippetContent === 'string') { %>
      <div class="mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
            <h2 class="text-xl font-semibold text-gray-200 mb-2 sm:mb-0">Code Snippet</h2>
            <div class="flex gap-3 flex-wrap">
                <button onclick="copyCode()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center">
                    <i class="fas fa-copy mr-2"></i>Copy Code
                </button>
                <a href="/codes/<%= code._id %>/download-snippet" target="_blank" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center">
                    <i class="fas fa-file-code mr-2"></i>Download Snippet File
                </a>
                <% if (code.snippetLanguage === 'htmlmixed' || code.snippetLanguage === 'html' || code.snippetLanguage === 'xml') { %>
                    <button onclick="showPreview()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center">
                    <i class="fas fa-eye mr-2"></i>Preview HTML
                    </button>
                <% } %>
            </div>
        </div>
        <pre class="shadow-md"><code id="codeblock" class="language-<%= code.snippetLanguage %>"><%- code.fetchedSnippetContent %></code></pre>
      </div>
    <% } else if (code.isSnippetTextFile && code.fetchedSnippetContent === null) { %>
        <div class="mb-8 bg-yellow-900 border border-yellow-700 text-yellow-300 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Note:</strong>
            <span class="block sm:inline">The code snippet content could not be loaded. It might be unavailable or there was an issue fetching it.</span>
        </div>
    <% } %>

    <% if (code.fileUrl && !code.isSnippetTextFile) { %>
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-200 mb-3">Associated File</h2>
        <div class="bg-gray-700 p-4 rounded-lg flex items-center justify-between">
          <div class="flex items-center">
            <i class="fas <%= code.fileType && code.fileType.includes('zip') ? 'fa-file-archive' : (code.fileType && code.fileType.includes('image') ? 'fa-file-image' : (code.fileType && code.fileType.includes('pdf') ? 'fa-file-pdf' : 'fa-file-alt')) %> text-2xl text-primary-400 mr-3"></i>
            <span class="text-gray-200"><%= code.fileName || 'Downloadable File' %></span>
          </div>
          <a href="<%= code.fileUrl %>" target="_blank" rel="noopener noreferrer" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-md text-sm font-medium transition flex items-center">
            <i class="fas fa-download mr-2"></i>Download File
          </a>
        </div>
      </div>
    <% } %>
    
    <div id="previewBox" class="mt-8 hidden">
      <h2 class="text-xl font-semibold text-gray-200 mb-3">Live Preview (HTML Snippet)</h2>
      <iframe id="previewFrame" class="w-full h-96 rounded-lg border-2 border-gray-700 bg-white shadow-md"></iframe>
    </div>

    <div class="my-6 flex items-center">
      <form action="/codes/<%= code._id %>/like" method="POST">
        <% let userHasLiked = false; %>
        <% if(currentUser && code.likes && code.likes.some(likeId => likeId.toString() === currentUser._id.toString())) { userHasLiked = true; } %>
        <button type="submit" class="like-button <%= userHasLiked ? 'liked' : '' %> text-gray-400 hover:text-red-500 transition-colors duration-150 py-2 px-4 rounded-lg flex items-center text-lg bg-gray-700 hover:bg-gray-600">
          <i class="fas fa-heart mr-2 <%= userHasLiked ? 'text-red-500' : 'text-gray-500' %>"></i> 
          <span><%= userHasLiked ? 'Unlike' : 'Like' %></span>
        </button>
      </form>
      <span class="ml-4 text-gray-400 text-lg"><%= code.likes ? code.likes.length : 0 %> Likes</span>
    </div>

    <div id="comments-section" class="mt-10 pt-6 border-t border-gray-700">
      <h2 class="text-2xl font-semibold text-gray-100 mb-6">Comments (<%= comments.length %>)</h2>
      <% if (currentUser) { %>
        <form action="/codes/<%= code._id %>/comments" method="POST" class="mb-8 bg-gray-700 p-4 rounded-lg shadow">
          <div class="mb-3">
            <label for="commentText" class="block text-sm font-medium text-gray-300 mb-1">Add a comment</label>
            <textarea name="comment[text]" id="commentText" rows="3" required
                      class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      placeholder="Write your thoughts..."></textarea>
          </div>
          <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold px-6 py-2.5 rounded-md transition duration-150">
            <i class="fas fa-paper-plane mr-2"></i>Post Comment
          </button>
        </form>
      <% } else { %>
        <p class="mb-8 text-gray-400">
          <a href="/login?redirect=/codes/view/<%= code._id %>" class="text-primary-400 hover:underline font-semibold">Login</a> to post a comment.
        </p>
      <% } %>

      <div class="space-y-6">
        <% if (comments.length > 0) { %>
          <% comments.forEach(comment => { %>
            <div class="comment bg-gray-700/50 p-4 rounded-lg shadow transition-shadow hover:shadow-md">
              <div class="flex justify-between items-start mb-2">
                <div class="flex items-center space-x-3">
                    <img src="<%= comment.author.id.avatar && comment.author.id.avatar.url ? comment.author.id.avatar.url : '/images/default-avatar.png' %>" alt="<%= comment.author.username %>" class="w-8 h-8 rounded-full object-cover">
                    <p class="text-sm text-gray-300 font-semibold">
                      <a href="/<%= comment.author.username.toLowerCase() %>" class="hover:underline"><%= comment.author.username %></a>
                    </p>
                </div>
                <p class="text-xs text-gray-500"><%= new Date(comment.createdAt).toLocaleString() %></p>
              </div>
              <p class="text-gray-200 whitespace-pre-wrap pl-11"><%- comment.text.replace(/\n/g, '<br>') %></p>
              <div class="pl-11 mt-2 flex justify-end space-x-3">
                <% if (currentUser && (comment.author.id._id.toString() === currentUser._id.toString() || (currentUser.role === 'admin' || (code.uploader && code.uploader._id.toString() === currentUser._id.toString() ))) ) { %>
                    <form action="/codes/<%= code._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Delete this comment?');">
                        <button type="submit" class="text-xs text-red-500 hover:text-red-400 hover:underline delete-comment-btn">
                            <i class="fas fa-trash-alt mr-1"></i>Delete
                        </button>
                    </form>
                <% } %>
                <!-- Tombol Report Komentar akan ditambahkan di sini jika fitur diimplementasikan -->
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-gray-500 italic">No comments yet. Be the first to comment!</p>
        <% } %>
      </div>
    </div>
  </article>

  <div class="text-center mt-8">
    <a href="/" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-6 py-3 rounded-md transition duration-150">
      <i class="fas fa-arrow-left mr-2"></i> Back to All Codes
    </a>
  </div>
</div>

<div id="copy-toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transition-opacity duration-300 z-[100]">
  Code copied to clipboard!
</div>

<div id="reportPostModal" class="fixed z-[100] inset-0 overflow-y-auto hidden" aria-labelledby="report-post-modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">â€‹</span>
        <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="reportPostForm" action="/codes/<%= code._id %>/report" method="POST">
                <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-700 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-flag text-red-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-100" id="report-post-modal-title">Report Post: "<%= code.title %>"</h3>
                            <div class="mt-4">
                                <label for="report_reason" class="block text-sm font-medium text-gray-300">Reason for reporting</label>
                                <textarea id="report_reason" name="reason" rows="4" required minlength="10" maxlength="500" class="mt-1 shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-600 rounded-md bg-gray-700 text-gray-200" placeholder="Please provide specific details..."></textarea>
                                <p class="mt-1 text-xs text-gray-500">Min 10 characters, max 500.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Submit Report
                    </button>
                    <button type="button" onclick="closeReportPostModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-gray-300 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
  function getDisplayedCodeContent() {
    const codeblock = document.getElementById("codeblock");
    return codeblock ? codeblock.innerText : null;
  }

  function copyCode() {
    const codeText = getDisplayedCodeContent();
    if (codeText === null || codeText.trim() === '') {
      alert("No code content to copy.");
      return;
    }
    navigator.clipboard.writeText(codeText).then(() => {
      const toast = document.getElementById('copy-toast');
      toast.classList.remove('opacity-0');
      setTimeout(() => {
        toast.classList.add('opacity-0');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy: ', err);
      alert("Failed to copy code.");
    });
  }

  function showPreview() {
    const iframe = document.getElementById("previewFrame");
    const content = getDisplayedCodeContent();
     if (content === null || content.trim() === '') {
      alert("No HTML content to preview.");
      return;
    }
    iframe.srcdoc = content;
    const previewBox = document.getElementById("previewBox");
    previewBox.classList.remove("hidden");
    previewBox.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  const reportPostModal = document.getElementById('reportPostModal');
  function openReportPostModal() {
      if(reportPostModal) reportPostModal.classList.remove('hidden');
  }
  function closeReportPostModal() {
      if(reportPostModal) reportPostModal.classList.add('hidden');
      const form = document.getElementById('reportPostForm');
      if(form) form.reset(); // Reset form saat modal ditutup
  }
</script>

<%- include('./partials/footer') %>