<%- include('./partials/header') %>

<div class="max-w-5xl mx-auto space-y-8">
  <article class="bg-gray-800 shadow-xl rounded-xl p-6 md:p-10">
    <header class="mb-6 border-b border-gray-700 pb-6">
      <div class="flex flex-col sm:flex-row justify-between items-start">
        <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-primary-400 to-pink-500 leading-tight mb-3 sm:mb-0">
          <%= code.title %>
        </h1>
        <% if (currentUser && code.uploader && currentUser._id.toString() === code.uploader._id.toString()) { %>
          <div class="flex space-x-3 flex-shrink-0 self-start sm:self-center">
            <a href="/codes/<%= code._id %>/edit" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-md transition duration-150 flex items-center">
              <i class="fas fa-edit mr-2"></i> Edit
            </a>
            <form action="/codes/<%= code._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this?');">
              <button type="submit" class="text-sm bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-md transition duration-150 flex items-center">
                <i class="fas fa-trash mr-2"></i> Delete
              </button>
            </form>
          </div>
        <% } %>
      </div>
      <div class="mt-4 text-sm text-gray-400 flex flex-wrap gap-x-4 gap-y-2 items-center">
        <span><i class="fas fa-user mr-1.5 text-primary-400"></i> By <%= code.uploader ? code.uploader.username : 'Unknown' %></span>
        <span><i class="fas fa-calendar-alt mr-1.5 text-primary-400"></i> <%= new Date(code.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></span>
        <span><i class="fas fa-tag mr-1.5 text-primary-400"></i> <span class="bg-gray-700 px-2 py-0.5 rounded-full text-xs"><%= code.snippetLanguage %></span></span>
        <span><i class="fas fa-eye mr-1.5 text-primary-400"></i> <%= code.views || 0 %> views</span>
        <% if (!code.isPublic) { %>
          <span class="text-yellow-400"><i class="fas fa-lock mr-1.5"></i> Private Post</span>
        <% } %>
      </div>
    </header>

    <% if (code.description) { %>
      <div class="prose prose-invert prose-sm md:prose-base max-w-none mb-8 text-gray-300">
        <h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-3">Description</h2>
        <p><%- code.description.replace(/\n/g, '<br>') %></p>
      </div>
    <% } %>

    <% if (code.isSnippetTextFile && code.fetchedSnippetContent !== null) { %>
      <div class="mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
            <h2 class="text-xl font-semibold text-gray-200 mb-2 sm:mb-0">Code Snippet</h2>
            <div class="flex gap-3 flex-wrap">
                <button onclick="copyCode()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center">
                    <i class="fas fa-copy mr-2"></i>Copy Code
                </button>
                <a href="/codes/<%= code._id %>/download-snippet" target="_blank" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center">
                    <i class="fas fa-file-code mr-2"></i>Download Snippet File
                </a>
                <% if (code.snippetLanguage === 'htmlmixed' || code.snippetLanguage === 'html' || code.snippetLanguage === 'xml') { %>
                    <button onclick="showPreview()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center">
                    <i class="fas fa-eye mr-2"></i>Preview HTML
                    </button>
                <% } %>
            </div>
        </div>
        <pre class="shadow-md"><code id="codeblock" class="language-<%= code.snippetLanguage %>"><%- code.fetchedSnippetContent %></code></pre>
      </div>
    <% } else if (code.isSnippetTextFile && code.fetchedSnippetContent === null) { %>
        <div class="mb-8 bg-yellow-900 border border-yellow-700 text-yellow-300 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Note:</strong>
            <span class="block sm:inline">The code snippet content could not be loaded. It might be unavailable or there was an issue fetching it.</span>
        </div>
    <% } %>


    <% if (code.fileUrl && !code.isSnippetTextFile) { %>
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-200 mb-3">Associated File</h2>
        <div class="bg-gray-700 p-4 rounded-lg flex items-center justify-between">
          <div class="flex items-center">
            <i class="fas <%= code.fileType && code.fileType.includes('zip') ? 'fa-file-archive' : (code.fileType && code.fileType.includes('image') ? 'fa-file-image' : (code.fileType && code.fileType.includes('pdf') ? 'fa-file-pdf' : 'fa-file-alt')) %> text-2xl text-primary-400 mr-3"></i>
            <span class="text-gray-200"><%= code.fileName || 'Downloadable File' %></span>
          </div>
          <a href="<%= code.fileUrl %>" target="_blank" rel="noopener noreferrer" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-md text-sm font-medium transition flex items-center">
            <i class="fas fa-download mr-2"></i>Download File
          </a>
        </div>
      </div>
    <% } %>
    
    <div id="previewBox" class="mt-8 hidden">
      <h2 class="text-xl font-semibold text-gray-200 mb-3">Live Preview (HTML Snippet)</h2>
      <iframe id="previewFrame" class="w-full h-96 rounded-lg border-2 border-gray-700 bg-white shadow-md"></iframe>
    </div>

  </article>

  <div class="text-center mt-8">
    <a href="/" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-6 py-3 rounded-md transition duration-150">
      <i class="fas fa-arrow-left mr-2"></i> Back to All Codes
    </a>
  </div>
</div>

<div id="copy-toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transition-opacity duration-300 z-[100]">
  Code copied to clipboard!
</div>


<script>
  function getDisplayedCodeContent() {
    const codeblock = document.getElementById("codeblock");
    return codeblock ? codeblock.innerText : null;
  }

  function copyCode() {
    const codeText = getDisplayedCodeContent();
    if (codeText === null || codeText.trim() === '') {
      alert("No code content to copy.");
      return;
    }
    navigator.clipboard.writeText(codeText).then(() => {
      const toast = document.getElementById('copy-toast');
      toast.classList.remove('opacity-0');
      setTimeout(() => {
        toast.classList.add('opacity-0');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy: ', err);
      alert("Failed to copy code.");
    });
  }

  function showPreview() {
    const iframe = document.getElementById("previewFrame");
    const content = getDisplayedCodeContent();
     if (content === null || content.trim() === '') {
      alert("No HTML content to preview.");
      return;
    }
    iframe.srcdoc = content;
    const previewBox = document.getElementById("previewBox");
    previewBox.classList.remove("hidden");
    previewBox.scrollIntoView({ behavior: "smooth", block: "center" });
  }
</script>

<%- include('./partials/footer') %>